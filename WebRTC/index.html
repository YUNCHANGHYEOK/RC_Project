<!DOCTYPE html> <!-- HTML5 ë¬¸ì„œì„ì„ ì„ ì–¸ -->
<html lang="ko"> <!-- ë¬¸ì„œ ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì • -->
<head>
  <meta charset="UTF-8" /> <!-- ë¬¸ì ì¸ì½”ë”©ì„ UTF-8ë¡œ ì§€ì • -->
  <title>ğŸ“¡ WebRTC ë¼ì¸íŠ¸ë ˆì´ì‹± ë·°ì–´</title> <!-- ë¸Œë¼ìš°ì € íƒ­ ì œëª© -->
  <style>
    /* ì „ì²´ í˜ì´ì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: sans-serif; /* ê¸°ë³¸ ê¸€ê¼´ */
      background: #111; /* ë°°ê²½ì„ ì–´ë‘ìš´ íšŒìƒ‰ìœ¼ë¡œ */
      color: #fff; /* ê¸€ììƒ‰ì€ í°ìƒ‰ */
      text-align: center; /* ê°€ìš´ë° ì •ë ¬ */
      padding-top: 20px;
    }

    /* ì˜ìƒ ì¶œë ¥ ì°½ ìŠ¤íƒ€ì¼ */
    video {
      width: 640px;
      height: 480px;
      background: black; /* ì´ˆê¸°ì—ëŠ” ê²€ì€ í™”ë©´ */
      margin: 10px auto;
      display: block;
      border: 2px solid #0f0; /* ì´ˆë¡ í…Œë‘ë¦¬ */
    }

    /* ì¤‘ì‹¬ ì¢Œí‘œ offset í‘œì‹œ ìŠ¤íƒ€ì¼ */
    #offset {
      font-size: 20px;
      margin-top: 10px;
    }

    /* ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #aaa; /* ì—°í•œ íšŒìƒ‰ */
    }
  </style>
</head>
<body>
  <h1>ğŸ¥ WebRTC ë¼ì¸íŠ¸ë ˆì´ì‹± ìŠ¤íŠ¸ë¦¬ë°</h1> <!-- í˜ì´ì§€ ìƒë‹¨ ì œëª© -->

  <!-- ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ í‘œì‹œ ì˜ì—­ -->
  <video id="video" autoplay playsinline muted></video>

  <!-- ì¤‘ì‹¬ ì¢Œí‘œì˜ xê°’ ê¸°ì¤€ offset ì¶œë ¥ -->
  <div>ğŸ“ Offset: <span id="offset">N/A</span></div>

  <!-- ìƒíƒœ ë©”ì‹œì§€ ì¶œë ¥ -->
  <div id="status">â³ ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

  <script>
    // HTML ìš”ì†Œ ë¶ˆëŸ¬ì˜¤ê¸°
    const video = document.getElementById("video");
    const offsetDisplay = document.getElementById("offset");
    const statusDiv = document.getElementById("status");

    // WebRTC í”¼ì–´ ì—°ê²° ìƒì„±
    const pc = new RTCPeerConnection();

    // ìˆ˜ì‹  ì „ìš© íŠ¸ëœì‹œë²„ ì¶”ê°€ (ì˜ìƒë§Œ ë°›ìŒ)
    pc.addTransceiver("video", { direction: "recvonly" });

    // ë¹„ë””ì˜¤ íŠ¸ë™ì´ ìˆ˜ì‹ ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë¨
    pc.ontrack = (event) => {
      console.log("ğŸ“º ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹ ë¨!");
      video.srcObject = event.streams[0]; // ë°›ì€ ìŠ¤íŠ¸ë¦¼ì„ ë¹„ë””ì˜¤ì— ì—°ê²°
      video.play().then(() => {
        statusDiv.textContent = "âœ… ì˜ìƒ ì¬ìƒ ì¤‘!"; // ì¬ìƒ ì„±ê³µ ì‹œ ë©”ì‹œì§€ ë³€ê²½
      }).catch((e) => {
        console.error("âŒ ì˜ìƒ ì¬ìƒ ì‹¤íŒ¨:", e);
        statusDiv.textContent = "âŒ ì˜ìƒ ì¬ìƒ ì˜¤ë¥˜: " + e.message; // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
      });
    };

    // ì„œë²„ì™€ WebSocket ì—°ê²° ì‹œì‘ (ê°™ì€ í˜¸ìŠ¤íŠ¸ì˜ 8765 í¬íŠ¸)
    const ws = new WebSocket("ws://" + location.hostname + ":8765");

    // WebSocket ì—°ê²°ì´ ì—´ë¦¬ë©´ ì‹¤í–‰ë¨
    ws.onopen = async () => {
      statusDiv.textContent = "ğŸ”— WebSocket ì—°ê²°ë¨. offer ì „ì†¡ ì¤‘...";
      const offer = await pc.createOffer(); // WebRTC ì—°ê²° ìš”ì²­ ìƒì„±
      await pc.setLocalDescription(offer);  // ë¡œì»¬ì— ì €ì¥
      ws.send(JSON.stringify(offer));       // WebSocketìœ¼ë¡œ ì„œë²„ì— ë³´ëƒ„
    };

    // WebSocketì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì‹¤í–‰ë¨
    ws.onmessage = async (event) => {
      try {
        const data = JSON.parse(event.data); // ë°›ì€ ë©”ì‹œì§€ë¥¼ JSONìœ¼ë¡œ íŒŒì‹±
        console.log("ğŸ“© WebSocket ìˆ˜ì‹ :", data);

        if (data.type === "answer") {
          // WebRTC ì—°ê²° ì‘ë‹µ ì²˜ë¦¬
          await pc.setRemoteDescription(data);
          statusDiv.textContent = "ğŸ‰ WebRTC ì—°ê²° ì™„ë£Œ!";
        } else if (data.x !== undefined && data.y !== undefined) {
          // ì•„ë‘ì´ë…¸ì—ì„œ ì „ì†¡í•œ ì¤‘ì‹¬ ì¢Œí‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ offset ê³„ì‚°
          const offset = data.x - 320; // 640 í•´ìƒë„ì˜ ì¤‘ì•™ x ì¢Œí‘œ ê¸°ì¤€
          offsetDisplay.textContent = offset;
        }
      } catch (e) {
        console.error("âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", e);
        statusDiv.textContent = "âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜";
      }
    };

    // WebSocket ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œ
    ws.onerror = (e) => {
      console.error("âŒ WebSocket ì˜¤ë¥˜:", e);
      statusDiv.textContent = "âŒ WebSocket ì—°ê²° ì˜¤ë¥˜";
    };

    // WebSocket ì—°ê²°ì´ ëŠê²¼ì„ ë•Œ
    ws.onclose = () => {
      console.warn("ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œë¨");
      statusDiv.textContent = "ğŸ”Œ ì—°ê²° ì¢…ë£Œë¨";
    };
  </script>
</body>
</html>
